name: Validate Payments Module

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  validate-payments:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug file tree
        run: |
          echo "üîç Listing Tabs directory"
          ls -R finance-wallet-onboarding/services/src/components/Tabs

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: Verify required files exist
        run: |
          required_paths=(
            "finance-wallet-onboarding/services/src/components/Tabs/PaymentsTab.tsx"
            "finance-wallet-onboarding/services/src/components/Payments/MastercardProvision.tsx"
            "finance-wallet-onboarding/services/src/components/Payments/VisaProvision.tsx"
            "finance-wallet-onboarding/services/src/components/Payments/BitcoinProvision.tsx"
            "finance-wallet-onboarding/codex/templates/provisioning.yaml"
            "finance-wallet-onboarding/services/src/config/tabs.config.ts"
          )
          for path in "${required_paths[@]}"; do
            if [ ! -f "$path" ]; then
              echo "‚ùå Missing: $path"
              exit 1
            else
              echo "‚úÖ Found: $path"
            fi
          done

      - name: Validate TypeScript build
        run: |
          npm install
          npm run build

      - name: Validate Codex provisioning template
        run: |
          grep "Payments Module Initialized" finance-wallet-onboarding/codex/templates/provisioning.yaml || {
            echo "‚ùå Codex provisioning event not found"
            exit 1
          }
          echo "‚úÖ Codex provisioning template verified"

      - name: Confirm tab registry injection
        run: |
          grep "PaymentsTab" finance-wallet-onboarding/services/src/config/tabs.config.ts || {
            echo "‚ùå PaymentsTab not injected into tab registry"
            exit 1
          }
          echo "‚úÖ PaymentsTab is registered"

      - name: Final shimmer confirmation
        run: echo "üåü Payments module validation complete ‚Äî crest shimmer confirmed."
# --- IGNORE ---